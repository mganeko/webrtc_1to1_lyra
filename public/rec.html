<!doctype html>
<html>

<head>
  <meta charset="UTF-8">
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Lyra rec/play</title>
</head>

<!-- TODO
  [ ] write/read local file with File System Access API
  [ ] rec/play PCM
  [ ] rec/play Lyra
  [ ] use container file for media
-->

<script>
  async function getFileHandleToWrite(name) {
    const handle = await window.showSaveFilePicker({ suggestedName: name });
    return handle;
  }

  async function writeTest() {
    const fileHandle = await getFileHandleToWrite('write_test.txt');
    //const file = await fileHandle.getFile();
    //let fileContents = await file.text();

    const writable = await fileHandle.createWritable();
    await writable.write("aBCdefg\n");
    await writable.close();
  }

  // --- media ----
  let audioCtx = null;

  let localStream = null;
  async function startMedia() {
    if (!audioCtx) {
      audioCtx = new AudioContext();
    }

    const options = {
      video: false,
      audio: true
      //audio: { sampleRate: 16000 }
    };
    const stream = await navigator.mediaDevices.getUserMedia(options);
    if (stream) {
      localStream = stream;
      startRec();
    }
  }

  function stopMedia() {
    if (localStream) {
      localStream.getTracks().forEach(track => track.stop());
      localStream = null;
    }
  }

  // 
  //  MediaStreamTrackProcessor
  //    https://github.com/mayitayew/lyra-demo/blob/main/index.js
  //  
  //
  let processor = null;
  let generator = null;
  let transformer = null;
  let processedStream = null;

  async function startRec() {
    if (!localStream) return;

    // WebAudio
    //const source = new MediaStreamAudioSourceNode(audioCtx, { mediaStream: localStream });
    //source.connect(audioCtx.destination);

    const audioTrack = localStream.getAudioTracks()[0];
    processor = new MediaStreamTrackProcessor( { track: audioTrack});
    generator = new MediaStreamTrackGenerator( { kind: 'audio'} );
    const source = processor.readable;
    const sink = generator.writable;
    transformer = new TransformStream({transform: encodeAndDecode()});
    source.pipeThrough(transformer).pipeTo(sink);
    processedStream = new MediaStream();
    processedStream.addTrack(generator);
    
    const audio = document.getElementById('playback_audio');
    audio.srcObject = processedStream;
    await audio.play();
  }

  function encodeAndDecode() {
    return (audiodata, controller) => {

      // --- Do nothing --
      //controller.enqueue(audiodata);
      // --- Do nothing --

      // --- copy ---
      const format = 'f32-planar';
      const current_buffer = new Float32Array(audiodata.numberOfFrames);
      audiodata.copyTo(current_buffer, {planeIndex: 0, format});
      const newAudioData = new AudioData({
        format: format,
        sampleRate: audiodata.sampleRate,
        numberOfFrames: audiodata.numberOfFrames,
        numberOfChannels: 1,
        timestamp: audiodata.timestamp,
        
        // A typed array of audio data.
        data: current_buffer,
      });
      audiodata.close();

      controller.enqueue(newAudioData);
    }
  }

</script>

<body>
  <button onclick="writeTest()">Write</button>
  <button type="button" onclick="startMedia();">Start Media</button>
  <button type="button" onclick="stopMedia();">Stop Media</button>
  <br />
  <audio id="playback_audio" controls="1" width="300px"></audio>
</body>

</html>